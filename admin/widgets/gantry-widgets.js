/**
 * @version   1.21 October 20, 2011
 * @author    RocketTheme http://www.rockettheme.com
 * @copyright Copyright (C) 2007 - 2011 RocketTheme, LLC
 * @license   http://www.gnu.org/licenses/gpl-2.0.html GNU/GPLv2 only
 */

var GantryWidgets={init:function(){GantryWidgets.dropdown();GantryWidgets.id=document.id("override_id").get("value").toInt();GantryWidgets.name=document.id("override_name").get("value");GantryWidgets.newPageHook();if(GantryWidgets.id!=-1){GantryWidgets.overrideWP();GantryWidgets.overrideCheckboxes();GantryWidgets.increase();}GantryWidgets.notices();new Tips(".rok-tips",{title:"data-tips"});(function(a){a("a.widget-action").live("click",function(){new Tips(".rok-tips",{title:"data-tips"});});})(jQuery);},dropdown:function(){var b=document.id("overrides-inside"),e=document.id("overrides-first"),c=null;var a=new Fx.Slide("overrides-inside",{duration:100,onStart:function(){var g=document.id("overrides-actions").getSize().x-4;b.setStyle("width",g);this.wrapper.setStyle("width",g+4);},onComplete:function(){if(!this.open){e.removeClass("slide-down");}}}).hide();b.setStyle("display","block");var d=function(){if(b.hasClass("slidedown")){a.slideIn();e.addClass("slide-down");}};var f=function(){if(b.hasClass("slideup")){a.slideOut();}};$$("#overrides-toggle, #overrides-inside").addEvents({mouseenter:function(){$clear(c);b.removeClass("slideup").addClass("slidedown");c=d();},mouseleave:function(){$clear(c);b.removeClass("slidedown").addClass("slideup");f.delay(300);}});GantryWidgets.dropdownActions();},dropdownActions:function(){var g=document.id("overrides-actions"),e=document.id("overrides-toolbar"),f=document.id("overrides-first");var a=document.id("overrides-toggle");if(e){var d=e.getElement(".button-add"),b=e.getElement(".button-del"),c=e.getElement(".button-edit");if(c){c.addEvent("click",function(){if(f.getElement("input")){f.getElement("input").empty().dispose();a.removeClass("hidden");return;}a.addClass("hidden");var h=new Element("input",{type:"text","class":"add-edit-input",value:f.get("text").clean().trim()});h.addEvent("keydown",function(l){if(l.key=="esc"){this.empty().dispose();a.removeClass("hidden");}else{if(l.key=="enter"){l.stop();var k=document.id("overrides-inside").getElements("a");var i=k.get("text").indexOf(this.value);if(i!=-1){this.highlight("#ff4b4b","#fff");return;}var j=this.value;new Request.HTML({url:AdminURI,onRequest:function(){var m=document.id("overrides-toolbar").getElement(".ajax-loading");if(m){m.setStyle("display","block");}},onSuccess:function(){var m=document.id("overrides-toolbar").getElement(".ajax-loading");if(m){m.setStyle("display","none");}i=k.get("text").indexOf(f.get("text").clean().trim());if(i!=-1){k[i].set("text",j);}h.empty().dispose();a.removeClass("hidden");f.getElement("a").set("text",j);}}).post({action:"gantry_admin",model:"widgets",gantry_action:"save-info",savewidgets:document.id("_wpnonce_widgets").get("value"),override_id:document.id("override_id").get("value"),override_name:j});}}});h.inject(f,"top").focus();});}}},newPageHook:function(){var b=$$(".button-add")[0];if(b){var a=new Request({url:AdminURI,onRequest:function(){var c=document.id("overrides-toolbar").getElement(".ajax-loading");if(c){c.setStyle("display","block");}},onSuccess:function(c){var d=c.clean().trim();if(d.length){window.location=d;}}});b.addEvent("click",function(c){c.stop();a.post({action:"gantry_admin",model:"widgets",gantry_action:"create-new",savewidgets:document.id("_wpnonce_widgets").get("value")});});}},increase:function(){$$("input.multi_number").each(function(a){var b=a.get("value").toInt()||false;if($chk(b)&&b<GantryWidgets.id*10000){a.set("value",(GantryWidgets.id*10000)+b);}});$$("input[name=widget-id]").filter(function(a){return !a.get("value").contains("__i__");}).each(function(e){var d=e.getNext("input[name=widget_number]");var c=e.getNext("input[name=id_base]").get("value");var g=e.getParent(".widget");var f=d.get("value").toInt();if(f<GantryWidgets.id*10000){var h=(GantryWidgets.id*10000)+f+500;var a=g.get("id").replace(/(\d+)$/,h);g.set("id",a);d.set("value",h);var b=a.split("_").slice(1);e.set("value",b.join("_"));e.getParent("form").getElements(".widget-content input, .widget-content label, .widget-content select, .widget-content textarea").each(function(k){var j=k.get("name"),l=k.get("id"),i=k.get("for");if(l){k.set("id",l.replace(/\d+/,h));}if(j){k.set("name",j.replace(/\d+/,h));}if(i){k.set("for",i.replace(/\d+/,h));}});}});},hookClick:function(a){(function(b){if(!a){a=b("#widgets-right").children(".widgets-holder-wrap").children(".sidebar-name");}else{a=b(a);}a.click(function(){var e=b(this).siblings(".widgets-sortables"),d=b(this).parent();if(!d.hasClass("closed")){e.sortable("disable");d.addClass("closed");}else{d.removeClass("closed");e.sortable("enable").sortable("refresh");}});})(jQuery);},unHookClick:function(a){(function(b){if(!a){a=b("#widgets-right").children(".widgets-holder-wrap").children(".sidebar-name");}else{a=b(a);}a.unbind("click");})(jQuery);},overrideCheckboxes:function(){GantryWidgets.unHookClick();$$(".override-checkbox").each(function(a){var b=a.getParent("h3");var e=a.getParent(".widgets-holder-wrap");var d=e.getElements(".widgets-sortables").filter(function(f){return f!=a.getParent(".widgets-sortables");});var c=a.getParent(".sidebar-name").getElement(".sidebar-name-arrow");a.inject(b,"before");$$(b,c).addEvent("click",function(f){if(!a.get("checked")&&f){f.stop();}else{if(!a.get("checked")&&e.hasClass("closed")){(function(g){g(d).sortable("disable");e.addClass.delay(1,e,"closed");})(jQuery);}else{(function(g){if(!e.hasClass("closed")){g(d).sortable("disable");e.addClass.delay(1,e,"closed");}else{g(d).sortable("enable").sortable("refresh");e.removeClass.delay(1,e,"closed");}g(d).sortable("refresh");})(jQuery);}}});a.addEvent("click",function(){var i=[];var g=e.getElement(".widgets-sortables").getChildren().filter(function(j){return j.get("id");});if(this.checked){c.setStyle("display","block");GantryWidgets.hookClick(c.getParent(".sidebar-name"));g.each(function(j){(function(l){var k=l(j);i.push(wpWidgets.save(k,0,0,1,true)._parseQueryString());})(jQuery);});if(!g.length){wpWidgets.saveOrder();}}else{c.setStyle("display","none");GantryWidgets.unHookClick(c.getParent(".sidebar-name"));g.each(function(j){(function(l){var k=l(j);i.push(wpWidgets.save(k,1,0,1,true)._parseQueryString());})(jQuery);});if(!g.length){wpWidgets.saveOrder();}}if(i.length){var h=JSON.encode(i);var f={action:"gantry_admin",model:"widgets",gantry_action:"widgets-mass-actions",savewidgets:document.id("_wpnonce_widgets").get("value"),override_id:GantryWidgets.id,override_name:document.id("override_name").get("value"),data:h};if(!this.checked){f.delete_widgets=1;}new Request({url:AdminURI,onSuccess:function(j){var k;(function(l){wpWidgets.saveOrder();})(jQuery);}}).post(f);}b.fireEvent("click");});if(!a.get("checked")){if(a.checked){c.setStyle("display","block");}else{c.setStyle("display","none");}b.fireEvent("click");}else{GantryWidgets.hookClick(c.getParent(".sidebar-name"));}});},overrideWP:function(){GantryWidgets.WPsave();GantryWidgets.WPsaveOrder();},WPsave:function(){wpWidgets.save=function(f,c,d,b,a){new Tips(".rok-tips",{title:"data-tips"});(function(g){sb=g(f).closest("div.widgets-sortables").attr("id");data=g(f).find("form").serialize();})(jQuery);$$(f[0]).getParent(".widgets-holder-wrap").getElement(".ajax-feedback").setStyle("visibility","visible");$$(f[0]).getElement(".ajax-feedback").setStyle("visibility","visible");var e=$$(".override-checkbox").filter(function(g){return g.checked;}).get("id");post={action:"gantry_admin",model:"widgets",gantry_action:"widgets-save",savewidgets:document.id("_wpnonce_widgets").get("value"),override_id:GantryWidgets.id,override_name:document.id("override_name").get("value"),overridden_sidebars:e.join(","),sidebar:sb};if(c){post.delete_widget=1;}data+="&"+(function(g){return g.param(post);})(jQuery);if(a){return data;}else{return new Request({url:AdminURI,onSuccess:function(g){var h;(function(i){if(c){if(!i("input.widget_number",f).val()){h=i("input.widget-id",f).val();i("#available-widgets").find("input.widget-id").each(function(){if(i(this).val()==h){i(this).closest("div.widget").show();}});}if(d){b=0;f.slideUp("fast",function(){i(this).remove();wpWidgets.saveOrder();});}else{f.remove();wpWidgets.resize();}}else{i(".ajax-feedback").css("visibility","hidden");if(g&&g.length>2){i("div.widget-content",f).html(g);wpWidgets.appendTitle(f);wpWidgets.fixLabels(f);}}if(b){wpWidgets.saveOrder();}})(jQuery);}}).post(data._parseQueryString());}};},WPsaveOrder:function(){wpWidgets.saveOrder=function(d,a){new Tips(".rok-tips",{title:"data-tips"});var b=$$(".override-checkbox").filter(function(e){return e.checked;}).get("id");var c={action:"gantry_admin",model:"widgets",gantry_action:"widgets-order",savewidgets:document.id("_wpnonce_widgets").get("value"),override_id:GantryWidgets.id,override_name:document.id("override_name").get("value"),overridden_sidebars:b.join(","),sidebars:[]};if(a){c.delete_widget=1;}$$("div.widgets-sortables").each(function(f){var e=f.getChildren().filter(function(g){return g.get("id");});c["sidebars["+f.get("id")+"]"]=e.get("id").join(",");});new Request({url:AdminURI,onRequest:function(){if(d){document.id(d).getParent(".widgets-holder-wrap").getElement("img.ajax-feedback").setStyle("visibility","visible");}},onSuccess:function(){$$("img.ajax-feedback").setStyle("visibility","hidden");wpWidgets.resize();}}).post(c);};},notices:function(){var b=$$(".gantry-notice");if(b.length){b.each(function(d){var e=d.getElement(".close");if(e){var c=new Fx.Tween(d,{duration:200,link:"ignore",onComplete:function(){if(document.id(d)){d.dispose();}}});e.addEvent("click",c.start.pass(["opacity",0],c));}});}var a=$$(".overrides-button.button-del");a.addEvent("click",function(d){var c=confirm(GantryLang.are_you_sure);if(!c){d.stop();}});}};String.implement({_parseQueryString:function(){var b=this.split(/[&;]/),a={};if(b.length){b.each(function(g){var c=g.indexOf("="),d=c<0?[""]:g.substr(0,c).match(/[^\]\[]+/g),e=decodeURIComponent(g.substr(c+1)).replace(/\+/g," "),f=a;d.each(function(j,h){j=decodeURIComponent(j);var k=f[j];if(h<d.length-1){f=f[j]=k||{};}else{if($type(k)=="array"){k.push(e);}else{f[j]=$defined(k)?[k,e]:e;}}});});}return a;}});window.addEvent("domready",GantryWidgets.init);